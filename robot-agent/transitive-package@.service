[Unit]
Description=Transitive Robotics Package Update Service

[Service]

# Mount (i.e., filesystem) sandboxing
PrivateUsers=true
ProtectSystem=full
# Note: "strict" would also make /tmp read-only, which would break some npm installs
ProtectHome=tmpfs
BindPaths=%h/.transitive/packages/%i:/home/transitive
BindReadOnlyPaths=%h/.transitive/usr:/home/usr
# to get .npm logs:
BindPaths=/tmp:/home/%u

# System call sandboxing
SystemCallArchitectures=native
NoNewPrivileges=true

WorkingDirectory=/home/transitive/
EnvironmentFile=%h/.transitive/.env

# generate a random password for this package to use
ExecStartPre=/usr/bin/bash -c "node -e \"fs.writeFileSync('password', Math.random().toString(36).substr(2, 9))\""
ExecStart=/usr/bin/bash -c ". /opt/ros/*/setup.bash && PATH=/home/usr/bin:$PATH && npm update && cd node_modules/@transitive-robotics/%i && env PASSWORD=$(cat ../../../password) npm start"
# Note: npm update also installs missing packages, see,
# https://stackoverflow.com/a/19824154/1087119
