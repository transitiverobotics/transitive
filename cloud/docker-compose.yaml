# Lines commented out with #DEV will get uncommented by docker-compose-dev which
# is just:
# `sed 's/#DEV//' docker-compose.yaml | docker-compose -f - $@`

version: "3.9"

networks:
  caps:
    attachable: true
  shared:
    attachable: true

services:
  # a minimal container that ensures certificates are present in the shared,
  # mounted volume
  ensure_certs:
    image: ensure_certs
    build: ./certs
    volumes:
      - ${TR_VAR_DIR:-.}/certs:/generated

  mongodb:
    build: ./mongo # with replset, required to watch for changes
    image: transitive/mongo:latest
    restart: always
    command: --replSet rs0
    volumes:
      - ${TR_VAR_DIR:-.}/db:/data/db
    networks:
      - default
      - caps # TODO: This means we'll need to enable authentication on the DB
      - shared
    logging:
      driver: local

  mosquitto:
    build: ./mosquitto
    image: transitive/mosquitto:latest
    restart: always
    depends_on:
      - ensure_certs
    volumes:
      - ${TR_VAR_DIR:-.}/certs:/mosquitto/certs
      - ${TR_VAR_DIR:-.}/mqtt_persistence:/persistence
    ports:
      - 8883:8883
      - 9001:9001
    networks:
      - default
      - caps
    logging:
      driver: local

  homepage:
    build:
      context: ./homepage
      args:
        - MONGO_URL=mongodb://mongodb
        - MONGO_DB=transitive
    image: transitive/homepage:latest
    restart: always
    volumes:
      - ${TR_VAR_DIR:-.}/static:/app/build/static
    ports:
      - 3000:3000
    depends_on:
      - mongodb
    env_file:
      - .env
    networks:
      - default
    logging:
      driver: local

  cloud:
    build:
      context: ./app
      args:
        - TR_HOST=${TR_HOST:-localhost}
      target: prod
      #DEVtarget: dev
    image: transitive/cloud:latest
    tty: true # to get colored logging output
    restart: always
    depends_on:
      - ensure_certs
      - mongodb
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ${TR_VAR_DIR:-.}/certs:/etc/mosquitto/certs
      # - ${TR_VAR_DIR:-.}/certs:/app/certs
      - /run/user/0:/run/user/0
      # DEV- ./app:/app # Not working, still, even after removing certs folder
      #DEV- ./app/src:/app/src
      #DEV- ./app/web_components:/app/web_components
      #DEV- ./app/public:/app/public
      #DEV- ./app/assets:/app/assets
      #DEV- ./app/docker.js:/app/docker.js
      #DEV- ./app/server.js:/app/server.js
      #DEV- ./app/utils.js:/app/utils.js
      #DEV- ./app/common.js:/app/common.js
      #DEV- ./app/install.js:/app/install.js
      #DEV- ../../transitive-caps/:/app/transitive-caps
    env_file:
      - .env
    ports:
      - 9000:9000
    networks:
      - default
      - caps
      - shared
    logging:
      driver: local

  proxy:
    build: ./proxy
    image: transitive/proxy:latest
    restart: always
    volumes:
      - ${TR_VAR_DIR:-.}/greenlock.d:/app/greenlock.d
    env_file:
      - .env
    ports:
      - 8000:8000
      - 80:80   #NODEV
      - 443:443 #NODEV
    networks:
      - default
      - shared
    logging:
      driver: local

  registry:
    build: ./registry
    image: transitive/registry:latest
    restart: always
    depends_on:
      - mongodb
    env_file:
      - .env
    ports:
      - 6000:6000
    networks:
      - default
      - shared
    logging:
      driver: local

  # Once the registry is up, republish the robot-agent to it, in case it changed
  publish:
    build: ../robot-agent
    image: transitive/publish:latest
    depends_on:
      - registry
    env_file:
      - .env
